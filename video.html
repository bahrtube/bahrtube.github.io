<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAHRTUBE - Видео</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </div>
                <div class="logo" onclick="window.location.href='index.html'">
                    <i class="fab fa-youtube" style="color: #ff0000; margin-right: 8px;"></i>
                    <h1>BAHRTUBE</h1>
                </div>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Поиск видео..." id="search-input">
                <button id="search-button"><i class="fas fa-search"></i></button>
            </div>
            <div class="header-right">
                <button class="mobile-search-btn" onclick="showMobileSearch()">
                    <i class="fas fa-search"></i>
                </button>
                <button class="upload-btn" onclick="checkUploadAccess()">
                    <i class="fas fa-upload"></i> <span>Загрузить</span>
                </button>
                <button class="auth-btn" id="auth-btn">
                    <i class="fas fa-user"></i> <span>Войти</span>
                </button>
            </div>
        </header>

        <div class="main-content">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <a href="index.html" class="nav-item">
                        <i class="fas fa-home"></i> Главная
                    </a>
                    <a href="#" class="nav-item" onclick="showNotification('Раздел "В тренде" в разработке', 'info')">
                        <i class="fas fa-fire"></i> В тренде
                    </a>
                    <a href="#" class="nav-item" onclick="showNotification('История просмотров в разработке', 'info')">
                        <i class="fas fa-history"></i> История
                    </a>
                    <div class="sidebar-divider"></div>
                    <h3 class="sidebar-title">Подписки</h3>
                    <div id="subscriptions-list">
                        <!-- Подписки будут загружены через JavaScript -->
                    </div>
                </nav>
            </aside>

            <main class="video-page">
                <!-- Основной контент видео -->
                <div class="video-main-content">
                    <div class="video-player-container">
                        <!-- Кастомный видеоплеер -->
                        <div class="video-player-wrapper" id="video-player-wrapper">
                            <div class="video-loading" id="video-loading">
                                <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
                                Загрузка плеера...
                            </div>
                            
                            <!-- Контейнер для YouTube iframe -->
                            <div id="youtube-iframe-container"></div>
                        </div>
                        
                        <div class="video-info">
                            <h1 id="video-title">Загрузка...</h1>
                            <div class="video-meta">
                                <div class="video-stats">
                                    <span id="video-views">0 просмотров</span>
                                    <span id="video-date">Сегодня</span>
                                </div>
                                <div class="video-actions">
                                    <button class="video-action-btn" id="like-btn">
                                        <i class="far fa-thumbs-up"></i>
                                        <span id="like-count">0</span>
                                    </button>
                                    <button class="video-action-btn" id="dislike-btn">
                                        <i class="far fa-thumbs-down"></i>
                                        <span id="dislike-count">0</span>
                                    </button>
                                    <button class="video-action-btn" id="share-btn">
                                        <i class="fas fa-share"></i> Поделиться
                                    </button>
                                    <button class="video-action-btn" id="save-btn">
                                        <i class="fas fa-plus"></i> Сохранить
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="video-channel">
                            <div class="channel-info" id="channel-info-click">
                                <div class="channel-avatar" id="channel-avatar">А</div>
                                <div class="channel-details">
                                    <h3 id="channel-name">Автор</h3>
                                    <span id="channel-subs">0 подписчиков</span>
                                </div>
                            </div>
                            <button class="subscribe-btn" id="subscribe-btn">
                                <i class="fas fa-bell"></i> Подписаться
                            </button>
                        </div>
                        
                        <div class="video-description">
                            <h3>Описание</h3>
                            <div class="description-content" id="video-description">
                                Загрузка...
                            </div>
                        </div>

                        <!-- КОММЕНТАРИИ -->
                        <div class="comments-section" id="comments-section">
                            <div class="comments-header">
                                <h3><i class="fas fa-comments"></i> Комментарии <span id="comments-count">0</span></h3>
                                <div class="comments-sort">
                                    <select id="comments-sort">
                                        <option value="newest">Сначала новые</option>
                                        <option value="popular">Сначала популярные</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Форма добавления комментария -->
                            <div class="add-comment" id="add-comment-form">
                                <div class="comment-avatar" id="comment-user-avatar">В</div>
                                <div class="comment-input-container">
                                    <textarea id="comment-input" placeholder="Добавьте комментарий..." rows="3"></textarea>
                                    <div class="comment-actions">
                                        <button class="cancel-comment-btn" id="cancel-comment-btn">Отмена</button>
                                        <button class="submit-comment-btn" id="submit-comment-btn">Комментировать</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Список комментариев -->
                            <div class="comments-list" id="comments-list">
                                <div class="no-comments">
                                    <i class="fas fa-comment-slash"></i>
                                    <p>Пока нет комментариев</p>
                                    <small>Будьте первым, кто оставит комментарий</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Боковая панель с рекомендациями -->
                <div class="recommendations-sidebar">
                    <h3><i class="fas fa-fire"></i> Рекомендации</h3>
                    <div class="recommendations-list" id="recommendations-list">
                        <!-- Рекомендации будут загружены через JavaScript -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- YouTube Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Наши скрипты -->
    <script src="auth.js"></script>
    <script src="script.js"></script>
    
    <!-- Основной скрипт для страницы видео -->
    <script>
        // Глобальные переменные для этой страницы
        let videoPlayer = null;
        let currentVideoData = null;
        let userLiked = false;
        let userDisliked = false;
        let userSubscribed = false;
        let userSaved = false;
        let controlsTimeout = null;
        
        // Класс для работы с комментариями
        class CommentsManager {
            constructor(videoId) {
                this.videoId = videoId;
                this.comments = [];
                this.currentUser = window.authDB ? window.authDB.getCurrentUser() : null;
                this.init();
            }
            
            async init() {
                await this.loadComments();
                this.setupEventListeners();
            }
            
            async loadComments() {
                try {
                    if (!window.database) {
                        console.error('Firebase не инициализирован');
                        return;
                    }
                    
                    const snapshot = await database.ref(`comments/${this.videoId}`).once('value');
                    const commentsData = snapshot.val() || {};
                    
                    // Преобразуем объект в массив
                    this.comments = Object.values(commentsData).sort((a, b) => 
                        (b.timestamp || 0) - (a.timestamp || 0)
                    );
                    
                    this.renderComments();
                    
                } catch (error) {
                    console.error('Ошибка загрузки комментариев:', error);
                }
            }
            
            setupEventListeners() {
                const submitBtn = document.getElementById('submit-comment-btn');
                const cancelBtn = document.getElementById('cancel-comment-btn');
                const commentInput = document.getElementById('comment-input');
                const sortSelect = document.getElementById('comments-sort');
                
                if (submitBtn && commentInput) {
                    submitBtn.onclick = () => this.addComment();
                    
                    commentInput.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 'Enter') {
                            this.addComment();
                        }
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.onclick = () => {
                        commentInput.value = '';
                        commentInput.style.height = 'auto';
                    };
                }
                
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        this.sortComments(e.target.value);
                    });
                }
                
                // Автоматическое изменение высоты textarea
                if (commentInput) {
                    commentInput.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = (this.scrollHeight) + 'px';
                    });
                }
            }
            
            async addComment() {
                const commentInput = document.getElementById('comment-input');
                const commentText = commentInput.value.trim();
                
                if (!commentText) {
                    if (window.showNotification) {
                        showNotification('Введите текст комментария', 'error');
                    }
                    return;
                }
                
                if (!this.currentUser) {
                    if (window.showNotification) {
                        showNotification('Для комментирования необходимо войти в аккаунт', 'error');
                    }
                    if (window.showAuthModal) {
                        showAuthModal('login');
                    }
                    return;
                }
                
                try {
                    const commentId = database.ref().child('comments').child(this.videoId).push().key;
                    
                    const commentData = {
                        id: commentId,
                        videoId: this.videoId,
                        userId: this.currentUser.id,
                        userName: this.currentUser.name || 'Аноним',
                        userAvatar: this.currentUser.channelAvatar || (this.currentUser.name ? this.currentUser.name.charAt(0).toUpperCase() : 'А'),
                        text: commentText,
                        timestamp: Date.now(),
                        likes: 0,
                        dislikes: 0,
                        replies: []
                    };
                    
                    await database.ref(`comments/${this.videoId}/${commentId}`).set(commentData);
                    
                    // Добавляем комментарий в массив
                    this.comments.unshift(commentData);
                    
                    // Обновляем UI
                    this.renderComments();
                    
                    // Очищаем поле ввода
                    commentInput.value = '';
                    commentInput.style.height = 'auto';
                    
                    // Показываем уведомление
                    if (window.showNotification) {
                        showNotification('Комментарий добавлен', 'success');
                    }
                    
                    // Обновляем счетчик комментариев
                    this.updateCommentsCount();
                    
                } catch (error) {
                    console.error('Ошибка добавления комментария:', error);
                    if (window.showNotification) {
                        showNotification('Ошибка добавления комментария', 'error');
                    }
                }
            }
            
            sortComments(sortBy) {
                switch(sortBy) {
                    case 'newest':
                        this.comments.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                        break;
                    case 'popular':
                        this.comments.sort((a, b) => {
                            const scoreA = (a.likes || 0) - (a.dislikes || 0);
                            const scoreB = (b.likes || 0) - (b.dislikes || 0);
                            return scoreB - scoreA;
                        });
                        break;
                }
                
                this.renderComments();
            }
            
            renderComments() {
                const commentsList = document.getElementById('comments-list');
                if (!commentsList) return;
                
                if (this.comments.length === 0) {
                    commentsList.innerHTML = `
                        <div class="no-comments">
                            <i class="fas fa-comment-slash"></i>
                            <p>Пока нет комментариев</p>
                            <small>Будьте первым, кто оставит комментарий</small>
                        </div>
                    `;
                    return;
                }
                
                commentsList.innerHTML = this.comments.map(comment => this.createCommentHTML(comment)).join('');
                
                // Добавляем обработчики событий для кнопок лайков/дизлайков комментариев
                this.addCommentInteractions();
                
                // Делаем ссылки кликабельными
                this.makeLinksClickable();
            }
            
            createCommentHTML(comment) {
                const timeAgo = this.formatTimeAgo(comment.timestamp);
                
                return `
                    <div class="comment-item" data-id="${comment.id}">
                        <div class="comment-avatar">${comment.userAvatar}</div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-author">${comment.userName}</span>
                                <span class="comment-time">${timeAgo}</span>
                            </div>
                            <div class="comment-text">${this.escapeHtml(comment.text)}</div>
                            <div class="comment-actions">
                                <button class="comment-action-btn like-btn" data-id="${comment.id}">
                                    <i class="far fa-thumbs-up"></i> <span class="like-count">${comment.likes || 0}</span>
                                </button>
                                <button class="comment-action-btn dislike-btn" data-id="${comment.id}">
                                    <i class="far fa-thumbs-down"></i> <span class="dislike-count">${comment.dislikes || 0}</span>
                                </button>
                                <button class="comment-action-btn reply-btn" onclick="if(window.showNotification) showNotification('Ответы на комментарии в разработке', 'info')">
                                    Ответить
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            addCommentInteractions() {
                document.querySelectorAll('.comment-action-btn.like-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const commentId = e.currentTarget.dataset.id;
                        this.likeComment(commentId);
                    });
                });
                
                document.querySelectorAll('.comment-action-btn.dislike-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const commentId = e.currentTarget.dataset.id;
                        this.dislikeComment(commentId);
                    });
                });
            }
            
            async likeComment(commentId) {
                if (!this.currentUser) {
                    if (window.showNotification) {
                        showNotification('Для оценки комментариев необходимо войти в аккаунт', 'error');
                    }
                    return;
                }
                
                try {
                    const commentRef = database.ref(`comments/${this.videoId}/${commentId}`);
                    const snapshot = await commentRef.once('value');
                    const comment = snapshot.val();
                    
                    if (!comment) return;
                    
                    // Увеличиваем счетчик лайков
                    const newLikes = (comment.likes || 0) + 1;
                    await commentRef.update({ likes: newLikes });
                    
                    // Обновляем UI
                    const likeCountEl = document.querySelector(`.comment-item[data-id="${commentId}"] .like-count`);
                    if (likeCountEl) {
                        likeCountEl.textContent = newLikes;
                    }
                    
                } catch (error) {
                    console.error('Ошибка лайка комментария:', error);
                }
            }
            
            async dislikeComment(commentId) {
                if (!this.currentUser) {
                    if (window.showNotification) {
                        showNotification('Для оценки комментариев необходимо войти в аккаунт', 'error');
                    }
                    return;
                }
                
                try {
                    const commentRef = database.ref(`comments/${this.videoId}/${commentId}`);
                    const snapshot = await commentRef.once('value');
                    const comment = snapshot.val();
                    
                    if (!comment) return;
                    
                    // Увеличиваем счетчик дизлайков
                    const newDislikes = (comment.dislikes || 0) + 1;
                    await commentRef.update({ dislikes: newDislikes });
                    
                    // Обновляем UI
                    const dislikeCountEl = document.querySelector(`.comment-item[data-id="${commentId}"] .dislike-count`);
                    if (dislikeCountEl) {
                        dislikeCountEl.textContent = newDislikes;
                    }
                    
                } catch (error) {
                    console.error('Ошибка дизлайка комментария:', error);
                }
            }
            
            updateCommentsCount() {
                const countElement = document.getElementById('comments-count');
                if (countElement) {
                    countElement.textContent = `(${this.comments.length})`;
                }
            }
            
            formatTimeAgo(timestamp) {
                if (!timestamp) return 'только что';
                
                const now = Date.now();
                const diff = now - timestamp;
                
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);
                const months = Math.floor(diff / 2592000000);
                const years = Math.floor(diff / 31536000000);
                
                if (years > 0) return `${years} год${this.getPlural(years)} назад`;
                if (months > 0) return `${months} месяц${this.getPlural(months)} назад`;
                if (days > 0) return `${days} день${this.getPlural(days)} назад`;
                if (hours > 0) return `${hours} час${this.getPlural(hours)} назад`;
                if (minutes > 0) return `${minutes} минут${this.getPlural(minutes)} назад`;
                return 'только что';
            }
            
            getPlural(num) {
                const lastDigit = num % 10;
                const lastTwoDigits = num % 100;
                
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) return 'ов';
                if (lastDigit === 1) return 'у';
                if (lastDigit >= 2 && lastDigit <= 4) return 'ы';
                return 'ов';
            }
            
            escapeHtml(text) {
                // Сначала заменяем специальные символы HTML
                let escaped = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                // Затем обрабатываем ссылки
                escaped = this.processLinks(escaped);
                
                // Затем обрабатываем таймкоды
                escaped = this.processTimestamps(escaped);
                
                // Затем обрабатываем переносы строк
                escaped = escaped.replace(/\n/g, '<br>');
                
                return escaped;
            }
            
            processLinks(text) {
                // Регулярное выражение для поиска URL
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, (url) => {
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-link">${url}</a>`;
                });
            }
            
            processTimestamps(text) {
                // Регулярное выражение для поиска таймкодов (например: 1:23, 01:23:45)
                const timestampRegex = /(\b\d{1,2}:)?\d{1,2}:\d{2}\b/g;
                return text.replace(timestampRegex, (timestamp) => {
                    const seconds = this.timestampToSeconds(timestamp);
                    if (seconds !== null) {
                        return `<span class="timestamp-link" data-timestamp="${seconds}">${timestamp}</span>`;
                    }
                    return timestamp;
                });
            }
            
            timestampToSeconds(timestamp) {
                const parts = timestamp.split(':').map(Number);
                
                if (parts.length === 2) {
                    // MM:SS
                    return parts[0] * 60 + parts[1];
                } else if (parts.length === 3) {
                    // HH:MM:SS
                    return parts[0] * 3600 + parts[1] * 60 + parts[2];
                }
                
                return null;
            }
            
            makeLinksClickable() {
                // Обработка кликов на ссылки
                document.querySelectorAll('.text-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });
                
                // Обработка кликов на таймкоды
                document.querySelectorAll('.timestamp-link').forEach(timestamp => {
                    timestamp.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const seconds = parseInt(timestamp.dataset.timestamp);
                        if (window.videoPlayer && window.videoPlayer.player && typeof window.videoPlayer.player.seekTo === 'function') {
                            window.videoPlayer.player.seekTo(seconds);
                        }
                    });
                });
            }
        }
        
        // Класс для управления видеоплеером
        class VideoPlayerManager {
            constructor() {
                this.player = null;
                this.youTubeId = null;
                this.currentVideoId = null;
                this.init();
            }
            
            async init() {
                console.log('Инициализация VideoPlayerManager');
                
                // Получаем ID видео из URL
                const urlParams = new URLSearchParams(window.location.search);
                this.currentVideoId = urlParams.get('id');
                
                console.log('Video ID:', this.currentVideoId);
                
                if (!this.currentVideoId) {
                    console.error('Нет ID видео в URL');
                    window.location.href = 'index.html';
                    return;
                }
                
                // Сохраняем ID видео в глобальной переменной
                window.currentVideoId = this.currentVideoId;
                
                // Загружаем информацию о видео
                await this.loadVideoInfo();
                
                // Инициализируем YouTube плеер
                this.initYouTubePlayer();
                
                // Настраиваем взаимодействия
                this.setupInteractions();
                
                // Инициализируем менеджер комментариев
                window.commentsManager = new CommentsManager(this.currentVideoId);
                
                // Загружаем рекомендации
                if (typeof loadRecommendations === 'function') {
                    loadRecommendations(this.currentVideoId);
                }
            }
            
            async loadVideoInfo() {
                try {
                    console.log('Загрузка информации о видео...');
                    
                    // Проверяем наличие объекта базы данных
                    if (!window.db || typeof window.db.getVideo !== 'function') {
                        console.error('База данных не инициализирована');
                        
                        // Устанавливаем заглушки
                        document.getElementById('video-title').textContent = 'База данных не загружена';
                        document.getElementById('video-views').textContent = '0 просмотров';
                        document.getElementById('video-date').textContent = 'Неизвестно';
                        document.getElementById('video-description').textContent = 'Пожалуйста, проверьте подключение к базе данных.';
                        return;
                    }
                    
                    currentVideoData = await window.db.getVideo(this.currentVideoId);
                    
                    console.log('Данные видео:', currentVideoData);
                    
                    if (!currentVideoData) {
                        console.error('Видео не найдено в базе данных');
                        showNotification('Видео не найдено', 'error');
                        window.location.href = 'index.html';
                        return;
                    }
                    
                    // Обновляем информацию на странице
                    document.getElementById('video-title').textContent = currentVideoData.title || 'Без названия';
                    document.getElementById('video-views').textContent = this.formatNumber(currentVideoData.views || 0) + ' просмотров';
                    document.getElementById('video-date').textContent = this.formatDate(currentVideoData.timestamp);
                    document.getElementById('like-count').textContent = this.formatNumber(currentVideoData.likes || 0);
                    document.getElementById('dislike-count').textContent = this.formatNumber(currentVideoData.dislikes || 0);
                    document.getElementById('channel-name').textContent = currentVideoData.channelName || 'Автор';
                    document.getElementById('channel-subs').textContent = this.formatNumber(currentVideoData.subscribers || 0) + ' подписчиков';
                    document.getElementById('channel-avatar').textContent = currentVideoData.channelAvatar || (currentVideoData.channelName || 'А').charAt(0);
                    
                    // Обрабатываем описание (делаем ссылки и таймкоды кликабельными)
                    const descriptionElement = document.getElementById('video-description');
                    if (descriptionElement) {
                        const description = currentVideoData.description || 'Нет описания';
                        descriptionElement.innerHTML = this.processText(description);
                        
                        // Добавляем обработчики для таймкодов
                        descriptionElement.querySelectorAll('.timestamp-link').forEach(timestamp => {
                            timestamp.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const seconds = parseInt(timestamp.dataset.timestamp);
                                if (this.player && typeof this.player.seekTo === 'function') {
                                    this.player.seekTo(seconds);
                                }
                            });
                        });
                    }
                    
                    // Увеличиваем просмотры
                    await window.db.updateVideo(this.currentVideoId, { 
                        views: (currentVideoData.views || 0) + 1 
                    });
                    
                    // Извлекаем YouTube ID
                    this.youTubeId = this.extractYouTubeId(currentVideoData.url);
                    console.log('YouTube ID:', this.youTubeId);
                    
                } catch (error) {
                    console.error('Ошибка загрузки видео:', error);
                    if (window.showNotification) {
                        showNotification('Ошибка загрузки видео', 'error');
                    }
                    
                    // Показываем заглушку
                    document.getElementById('video-title').textContent = 'Ошибка загрузки';
                    document.getElementById('video-description').textContent = 'Не удалось загрузить информацию о видео. Пожалуйста, обновите страницу.';
                }
            }
            
            initYouTubePlayer() {
                if (!this.youTubeId) {
                    console.error('Не удалось получить YouTube ID');
                    document.getElementById('video-loading').innerHTML = `
                        <div style="text-align: center; color: #f44336;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                            <h3 style="margin-bottom: 12px;">Ошибка загрузки видео</h3>
                            <p>Не удалось найти видео</p>
                            <button onclick="window.history.back()" style="padding: 10px 20px; background-color: #2E7D32; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Назад
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log('Инициализация YouTube плеера с ID:', this.youTubeId);
                
                // Проверяем, загружена ли YouTube API
                if (window.YT && window.YT.Player) {
                    console.log('YouTube API загружена, создаем плеер');
                    this.createPlayer();
                } else {
                    console.log('YouTube API не загружена, ждем...');
                    window.onYouTubeIframeAPIReady = () => {
                        console.log('YouTube API готова');
                        this.createPlayer();
                    };
                    
                    setTimeout(() => {
                        if (window.YT && window.YT.Player && !this.player) {
                            console.log('Создаем плеер после таймаута');
                            this.createPlayer();
                        } else if (!this.player) {
                            console.error('YouTube API не загрузилась');
                            document.getElementById('video-loading').innerHTML = `
                                <div style="text-align: center; color: #f44336;">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <p>Ошибка загрузки YouTube плеера</p>
                                </div>
                            `;
                        }
                    }, 3000);
                }
            }
            
            createPlayer() {
                try {
                    console.log('Создание YouTube плеера...');
                    
                    this.player = new YT.Player('youtube-iframe-container', {
                        height: '100%',
                        width: '100%',
                        videoId: this.youTubeId,
                        playerVars: {
                            'autoplay': 1,
                            'controls': 1,
                            'rel': 0,
                            'showinfo': 0,
                            'iv_load_policy': 3,
                            'modestbranding': 1
                        },
                        events: {
                            'onReady': (event) => this.onPlayerReady(event),
                            'onStateChange': (event) => this.onPlayerStateChange(event)
                        }
                    });
                    
                } catch (error) {
                    console.error('Ошибка создания плеера:', error);
                    document.getElementById('video-loading').innerHTML = `
                        <div style="text-align: center; color: #f44336;">
                            <h3>Ошибка создания плеера</h3>
                            <p>${error.message}</p>
                        </div>
                    `;
                }
            }
            
            onPlayerReady(event) {
                console.log('Плеер YouTube готов');
                document.getElementById('video-loading').style.display = 'none';
            }
            
            onPlayerStateChange(event) {
                // Можно добавить логику при изменении состояния плеера
            }
            
            setupInteractions() {
                console.log('Настройка взаимодействий...');
                
                // Кнопка лайка
                const likeBtn = document.getElementById('like-btn');
                if (likeBtn) {
                    likeBtn.addEventListener('click', () => this.handleLike());
                }
                
                // Кнопка дизлайка
                const dislikeBtn = document.getElementById('dislike-btn');
                if (dislikeBtn) {
                    dislikeBtn.addEventListener('click', () => this.handleDislike());
                }
                
                // Кнопка поделиться
                const shareBtn = document.getElementById('share-btn');
                if (shareBtn) {
                    shareBtn.addEventListener('click', () => this.handleShare());
                }
                
                // Кнопка сохранить
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => this.handleSave());
                    // Проверяем, сохранено ли видео
                    this.checkIfSaved();
                }
                
                // Кнопка подписки
                const subscribeBtn = document.getElementById('subscribe-btn');
                if (subscribeBtn) {
                    subscribeBtn.addEventListener('click', () => this.handleSubscribe());
                    // Проверяем, подписан ли пользователь
                    this.checkSubscription();
                }
                
                // Переход на канал
                const channelInfo = document.getElementById('channel-info-click');
                if (channelInfo) {
                    channelInfo.addEventListener('click', () => {
                        if (currentVideoData && currentVideoData.channelId) {
                            window.location.href = `channel.html?id=${currentVideoData.channelId}`;
                        }
                    });
                }
            }
            
            async handleLike() {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user) {
                    if (window.showNotification) {
                        showNotification('Для оценки видео необходимо войти в аккаунт', 'error');
                    }
                    if (window.showAuthModal) {
                        showAuthModal('login');
                    }
                    return;
                }
                
                try {
                    if (userLiked) {
                        // Убираем лайк
                        await window.db.updateVideo(this.currentVideoId, {
                            likes: Math.max((currentVideoData.likes || 0) - 1, 0)
                        });
                        userLiked = false;
                        document.getElementById('like-btn').classList.remove('liked');
                        currentVideoData.likes = Math.max((currentVideoData.likes || 0) - 1, 0);
                    } else {
                        // Ставим лайк
                        await window.db.updateVideo(this.currentVideoId, {
                            likes: (currentVideoData.likes || 0) + 1
                        });
                        userLiked = true;
                        document.getElementById('like-btn').classList.add('liked');
                        currentVideoData.likes = (currentVideoData.likes || 0) + 1;
                        
                        // Если был дизлайк, убираем его
                        if (userDisliked) {
                            await window.db.updateVideo(this.currentVideoId, {
                                dislikes: Math.max((currentVideoData.dislikes || 0) - 1, 0)
                            });
                            userDisliked = false;
                            document.getElementById('dislike-btn').classList.remove('disliked');
                            currentVideoData.dislikes = Math.max((currentVideoData.dislikes || 0) - 1, 0);
                        }
                    }
                    
                    // Обновляем счетчики
                    document.getElementById('like-count').textContent = this.formatNumber(currentVideoData.likes);
                    document.getElementById('dislike-count').textContent = this.formatNumber(currentVideoData.dislikes);
                    
                    // Сохраняем информацию о лайке в профиле пользователя
                    await this.saveUserReaction('liked');
                    
                } catch (error) {
                    console.error('Ошибка лайка:', error);
                    if (window.showNotification) {
                        showNotification('Ошибка оценки видео', 'error');
                    }
                }
            }
            
            async handleDislike() {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user) {
                    if (window.showNotification) {
                        showNotification('Для оценки видео необходимо войти в аккаунт', 'error');
                    }
                    if (window.showAuthModal) {
                        showAuthModal('login');
                    }
                    return;
                }
                
                try {
                    if (userDisliked) {
                        // Убираем дизлайк
                        await window.db.updateVideo(this.currentVideoId, {
                            dislikes: Math.max((currentVideoData.dislikes || 0) - 1, 0)
                        });
                        userDisliked = false;
                        document.getElementById('dislike-btn').classList.remove('disliked');
                        currentVideoData.dislikes = Math.max((currentVideoData.dislikes || 0) - 1, 0);
                    } else {
                        // Ставим дизлайк
                        await window.db.updateVideo(this.currentVideoId, {
                            dislikes: (currentVideoData.dislikes || 0) + 1
                        });
                        userDisliked = true;
                        document.getElementById('dislike-btn').classList.add('disliked');
                        currentVideoData.dislikes = (currentVideoData.dislikes || 0) + 1;
                        
                        // Если был лайк, убираем его
                        if (userLiked) {
                            await window.db.updateVideo(this.currentVideoId, {
                                likes: Math.max((currentVideoData.likes || 0) - 1, 0)
                            });
                            userLiked = false;
                            document.getElementById('like-btn').classList.remove('liked');
                            currentVideoData.likes = Math.max((currentVideoData.likes || 0) - 1, 0);
                        }
                    }
                    
                    // Обновляем счетчики
                    document.getElementById('like-count').textContent = this.formatNumber(currentVideoData.likes);
                    document.getElementById('dislike-count').textContent = this.formatNumber(currentVideoData.dislikes);
                    
                    // Сохраняем информацию о дизлайке в профиле пользователя
                    await this.saveUserReaction('disliked');
                    
                } catch (error) {
                    console.error('Ошибка дизлайка:', error);
                    if (window.showNotification) {
                        showNotification('Ошибка оценки видео', 'error');
                    }
                }
            }
            
            async handleShare() {
                const videoUrl = window.location.href;
                
                try {
                    // Пробуем использовать Clipboard API
                    await navigator.clipboard.writeText(videoUrl);
                    if (window.showNotification) {
                        showNotification('Ссылка скопирована в буфер обмена', 'success');
                    }
                } catch (error) {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = videoUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    if (window.showNotification) {
                        showNotification('Ссылка скопирована в буфер обмена', 'success');
                    }
                }
            }
            
            async handleSave() {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user) {
                    if (window.showNotification) {
                        showNotification('Для сохранения видео необходимо войти в аккаунт', 'error');
                    }
                    if (window.showAuthModal) {
                        showAuthModal('login');
                    }
                    return;
                }
                
                try {
                    if (userSaved) {
                        // Убираем из сохраненных
                        const savedVideos = user.savedVideos || [];
                        const newSavedVideos = savedVideos.filter(id => id !== this.currentVideoId);
                        await window.authDB.updateUser(user.id, { savedVideos: newSavedVideos });
                        userSaved = false;
                        document.getElementById('save-btn').innerHTML = '<i class="fas fa-plus"></i> Сохранить';
                        if (window.showNotification) {
                            showNotification('Видео удалено из сохраненных', 'success');
                        }
                    } else {
                        // Добавляем в сохраненные
                        const savedVideos = user.savedVideos || [];
                        if (!savedVideos.includes(this.currentVideoId)) {
                            savedVideos.push(this.currentVideoId);
                            await window.authDB.updateUser(user.id, { savedVideos: savedVideos });
                        }
                        userSaved = true;
                        document.getElementById('save-btn').innerHTML = '<i class="fas fa-check"></i> Сохранено';
                        if (window.showNotification) {
                            showNotification('Видео добавлено в сохраненные', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Ошибка сохранения видео:', error);
                    if (window.showNotification) {
                        showNotification('Ошибка сохранения видео', 'error');
                    }
                }
            }
            
            async handleSubscribe() {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user) {
                    if (window.showNotification) {
                        showNotification('Для подписки необходимо войти в аккаунт', 'error');
                    }
                    if (window.showAuthModal) {
                        showAuthModal('login');
                    }
                    return;
                }
                
                if (!currentVideoData || !currentVideoData.channelId) {
                    if (window.showNotification) {
                        showNotification('Ошибка подписки: канал не найден', 'error');
                    }
                    return;
                }
                
                try {
                    if (userSubscribed) {
                        // Отписываемся
                        const result = await window.authDB.unsubscribeFromChannel(currentVideoData.channelId, user.id);
                        if (result.success) {
                            userSubscribed = false;
                            document.getElementById('subscribe-btn').innerHTML = '<i class="fas fa-bell"></i> Подписаться';
                            document.getElementById('subscribe-btn').className = 'subscribe-btn';
                            currentVideoData.subscribers = Math.max((currentVideoData.subscribers || 0) - 1, 0);
                            document.getElementById('channel-subs').textContent = this.formatNumber(currentVideoData.subscribers) + ' подписчиков';
                            if (window.showNotification) {
                                showNotification('Вы отписались от канала', 'success');
                            }
                        }
                    } else {
                        // Подписываемся
                        const result = await window.authDB.subscribeToChannel(currentVideoData.channelId, user.id);
                        if (result.success) {
                            userSubscribed = true;
                            document.getElementById('subscribe-btn').innerHTML = '<i class="fas fa-check"></i> Вы подписаны';
                            document.getElementById('subscribe-btn').className = 'subscribe-btn subscribed';
                            currentVideoData.subscribers = (currentVideoData.subscribers || 0) + 1;
                            document.getElementById('channel-subs').textContent = this.formatNumber(currentVideoData.subscribers) + ' подписчиков';
                            if (window.showNotification) {
                                showNotification('Вы подписались на канал!', 'success');
                            }
                            
                            // Обновляем подписки в сайдбаре
                            if (typeof loadUserSubscriptions === 'function') {
                                loadUserSubscriptions();
                            }
                        }
                    }
                } catch (error) {
                    console.error('Ошибка подписки:', error);
                    if (window.showNotification) {
                        showNotification('Ошибка подписки', 'error');
                    }
                }
            }
            
            async checkSubscription() {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user || !currentVideoData) return;
                
                const userSubscriptions = user.subscriptions || [];
                userSubscribed = userSubscriptions.includes(currentVideoData.channelId);
                
                const subscribeBtn = document.getElementById('subscribe-btn');
                if (subscribeBtn) {
                    if (userSubscribed) {
                        subscribeBtn.innerHTML = '<i class="fas fa-check"></i> Вы подписаны';
                        subscribeBtn.className = 'subscribe-btn subscribed';
                    } else {
                        subscribeBtn.innerHTML = '<i class="fas fa-bell"></i> Подписаться';
                        subscribeBtn.className = 'subscribe-btn';
                    }
                }
            }
            
            async checkIfSaved() {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user) return;
                
                const savedVideos = user.savedVideos || [];
                userSaved = savedVideos.includes(this.currentVideoId);
                
                const saveBtn = document.getElementById('save-btn');
                if (saveBtn) {
                    if (userSaved) {
                        saveBtn.innerHTML = '<i class="fas fa-check"></i> Сохранено';
                    } else {
                        saveBtn.innerHTML = '<i class="fas fa-plus"></i> Сохранить';
                    }
                }
            }
            
            async saveUserReaction(type) {
                const user = window.authDB ? window.authDB.getCurrentUser() : null;
                if (!user) return;
                
                try {
                    const reactions = user.reactions || {};
                    reactions[this.currentVideoId] = type; // 'liked' или 'disliked'
                    
                    await window.authDB.updateUser(user.id, { reactions: reactions });
                } catch (error) {
                    console.error('Ошибка сохранения реакции:', error);
                }
            }
            
            seekTo(seconds) {
                if (this.player && typeof this.player.seekTo === 'function') {
                    this.player.seekTo(seconds, true);
                }
            }
            
            processText(text) {
                if (!text) return '';
                
                // Экранируем HTML
                let processed = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                // Обрабатываем ссылки
                processed = this.processLinks(processed);
                
                // Обрабатываем таймкоды
                processed = this.processTimestamps(processed);
                
                // Обрабатываем переносы строк
                processed = processed.replace(/\n/g, '<br>');
                
                return processed;
            }
            
            processLinks(text) {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, (url) => {
                    return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-link">${url}</a>`;
                });
            }
            
            processTimestamps(text) {
                const timestampRegex = /(\b\d{1,2}:)?\d{1,2}:\d{2}\b/g;
                return text.replace(timestampRegex, (timestamp) => {
                    const seconds = this.timestampToSeconds(timestamp);
                    if (seconds !== null) {
                        return `<span class="timestamp-link" data-timestamp="${seconds}">${timestamp}</span>`;
                    }
                    return timestamp;
                });
            }
            
            timestampToSeconds(timestamp) {
                const parts = timestamp.split(':').map(Number);
                
                if (parts.length === 2) {
                    return parts[0] * 60 + parts[1];
                } else if (parts.length === 3) {
                    return parts[0] * 3600 + parts[1] * 60 + parts[2];
                }
                
                return null;
            }
            
            extractYouTubeId(url) {
                if (!url) return null;
                
                try {
                    const patterns = [
                        /(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/,
                        /youtube\.com\/embed\/([^&\n?#]+)/,
                        /youtube\.com\/v\/([^&\n?#]+)/
                    ];
                    
                    for (const pattern of patterns) {
                        const match = url.match(pattern);
                        if (match && match[1]) {
                            return match[1];
                        }
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Ошибка извлечения YouTube ID:', error);
                    return null;
                }
            }
            
            formatNumber(num) {
                if (!num) return '0';
                
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
                }
                if (num >= 1000) {
                    return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
                }
                return num.toString();
            }
            
            formatDate(timestamp) {
                if (!timestamp) return 'Неизвестно';
                
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Сегодня';
                if (diffDays === 1) return 'Вчера';
                if (diffDays < 7) return `${diffDays} дней назад`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} недель назад`;
                if (diffDays < 365) return `${Math.floor(diffDays / 30)} месяцев назад`;
                
                return `${Math.floor(diffDays / 365)} лет назад`;
            }
        }
        
        // Инициализация страницы
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Страница видео загружена');
            
            // Проверяем загрузку скриптов
            console.log('authDB:', typeof window.authDB !== 'undefined' ? 'загружен' : 'не загружен');
            console.log('db:', typeof window.db !== 'undefined' ? 'загружен' : 'не загружен');
            console.log('YT API:', typeof window.YT !== 'undefined' ? 'загружена' : 'не загружена');
            
            // Инициализируем аутентификацию
            if (typeof checkAuthOnLoad === 'function') {
                checkAuthOnLoad();
            }
            
            // Скрываем sidebar на мобильных
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                if (sidebar) sidebar.classList.add('closed');
                if (mainContent) mainContent.classList.add('sidebar-hidden');
            }
            
            // Инициализируем менеджер видеоплеера
            videoPlayer = new VideoPlayerManager();
            window.videoPlayer = videoPlayer;
        });
    </script>
</body>
</html>
